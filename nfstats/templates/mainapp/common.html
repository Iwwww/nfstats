{% extends 'mainapp/base_charts.html' %}


{% block page-controls %}
	<button type="button" class="btn btn-outline-success ml-2" onclick="getChartsData()">Show</button>
	<button id="aggregate" type="button" class="btn btn-danger ml-2 hide" onclick="agregateCharts()">Aggregate</button>
{% endblock %}

{% block content %}

<div class="container-fluid mb-3">
{% for interface in interfaces %}
<div class="row mt-3 justify-content-center">
	<div class="mr-2 ml-2">
		<div class="card">
			<div class="card-body text-center">
				<h5 class="card-title text-center mb-0">{{ interface.description }}</h5>
				<small class="charts-title">{{ interface.name }}</small>
				<div class="col text-center mt-2" id='{{ interface.snmpid }}_src'>{{ interface.name }}</div>
			</div>
			<div class="card-footer text-muted text-center">Source AS</div>
		</div>
	</div>
	<div class="ml-2 mr-2">
		<div class="card">
			<div class="card-body text-center">
				<h5 class="card-title text-center mb-0">{{ interface.description }}</h5>
				<small class="charts-title">{{ interface.name }}</small>
				<div class="col text-center mt-2" id='{{ interface.snmpid }}_dst'>{{ interface.name }}</div>
			</div>
			<div class="card-footer text-muted">
				<div class="row">
					<div class="col-6 pr-0 text-right">Destination AS</div>
					<div class="col-6 text-right">{% if not aggregate %}<input id="{{ interface.snmpid }}" type="checkbox" class="mt-1 aggr_checkbox">{% endif %}</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endfor %}
</div>
<script>
pieChartOptionsSource = {	tooltip: {trigger: 'none'},
						'width': 590,
						'colors' : ['#5f937d'],
						'height': 350,
						chartArea: { height: '200%', top: '0%', left:'10%', width: '200%'},
						'sliceVisibilityThreshold': 0.005,
						'legendColor' : ['222']
						}

pieChartOptionsSourceDest = { tooltip: {trigger: 'none'},
							'width': 590,
							'colors' : ['#5f89a9'],
							'height': 350,
							chartArea: { height: '200%', top: '0%', left:'10%', width: '200%'},
							'sliceVisibilityThreshold': 0.005,
							'legendColor' : ['222']
							}


google.charts.load('current', {'packages':['corechart', 'sankey']});
google.charts.setOnLoadCallback(getChartsData);


$('.aggr_checkbox').change(function(){
	doAggregate = false;
	$('.aggr_checkbox').each(function(){
		if ($(this).is(':checked'))
			doAggregate	= true;
	})
	if (doAggregate) $("#aggregate").show(200);
	else $("#aggregate").hide(200);
})



function getChartsData() {
	var host = $('#host-select').val();
	var date = new Date(dateToISO($('#date-select').val()));
	var direction = $('#direction-select').val();
	$.ajax({
			  type: 'post',
			  url: 'get_pie_chart_data',
			  dataType: "json",
			  data: {
				'host' : host,
				'date' : date.toISOString(),
				'direction' : direction,
				'aggregate' : {% if aggregate %} '{{ aggregate }}' {% else %} '' {% endif %}
			  },
			  success: function(data){		
				  drawCharts(data);
			  },
			  async: true
	})
}

function addRipeData(as) {
	$.ajax({
		type: "get",
		url: "https://stat.ripe.net/data/whois/data.json",
		data:  {'resource': as },
				dataType: "json",
		success: function(ripeData){
				   var netname = ripeData.data.records[0][1]['value'] + ' ' + ripeData.data.records[0][2]['value'];
				   $('#dynamic-alert-success').append('<br>ASName: ' + netname);
	}});
};



{% for interface in interfaces %}
function chart{{interface.snmpid}}Source(chartsData){
	var data = google.visualization.arrayToDataTable(chartsData['{{interface.snmpid}}']['source']);
	var chart = new google.visualization.PieChart(document.getElementById('{{ interface.snmpid }}_src'));
	chart.draw(data, pieChartOptionsSource);
	google.visualization.events.addListener(chart, 'select', selectaction);
	function selectaction(e) { 
		if (chart.getSelection()[0]) {
				var as = data.getValue(chart.getSelection()[0].row, 0);
				var mbps = data.getValue(chart.getSelection()[0].row, 1);
				var msg = 'AS' + as + ' <b>(' + mbps + ' Mbps)</b>'
				$('#dynamic-alert-success').html(msg);
				$('#dynamic-alert-success').show();
				addRipeData(as);
		}
	}
}
function chart{{interface.snmpid}}Dest(chartsData){
	var data = google.visualization.arrayToDataTable(chartsData['{{interface.snmpid}}']['destination']);
	var chart = new google.visualization.PieChart(document.getElementById('{{ interface.snmpid }}_dst'));
	chart.draw(data, pieChartOptionsSourceDest);
	google.visualization.events.addListener(chart, 'select', selectaction);
	function selectaction(e) { 
		if (chart.getSelection()[0]) {
			var as = data.getValue(chart.getSelection()[0].row, 0);
			var mbps = data.getValue(chart.getSelection()[0].row, 1);
			var msg = 'AS' + as + ' <b>(' + mbps + ' Mbps)</b>'
			$('#dynamic-alert-success').html(msg);
			$('#dynamic-alert-success').show();
			addRipeData(as);
		}
	}
}
{% endfor %}

function drawCharts(chartsData) {
	{% for interface in interfaces %}
		if (!chartsData['{{interface.snmpid}}']['error']){ 
			chart{{interface.snmpid}}Source(chartsData)
			chart{{interface.snmpid}}Dest(chartsData)
		} else {
			$('#dynamic-alert-danger').append(chartsData['{{interface.snmpid}}']['error'] + "<br>");
			$('#dynamic-alert-danger').show();
		}
	{% endfor %}
}

$('#host-select').change(function(){
	document.location.href = "?host=" + $('#host-select').val() + "&direction=" + $('#direction-select').val();
})

$('#direction-select').change(function(){
	document.location.href = "?host=" + $('#host-select').val() + "&direction=" + $('#direction-select').val();
})

function getAggregateInterfaces() {
	interfaces = "";
	$('.aggr_checkbox').each(function(){
		if ($(this).is(':checked'))
			interfaces += this.id + ",";
	})
	return interfaces;
}


function agregateCharts() {
	//console.log(getAggregateInterfaces())
	document.location.href = "?host=" + $('#host-select').val() + "&direction=" + $('#direction-select').val() + "&aggregate=" + getAggregateInterfaces();
}

</script>

{% endblock %}
