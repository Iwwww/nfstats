{% extends 'mainapp/base_charts.html' %}

{% block page-controls %}
<div class="input-group text-input-group ml-2">
	<div class="input-group-prepend">
		<label class="input-group-text" for="interface-select">Interface:</label>
	</div>
	<select class="custom-select" id="interface-select">
		{% for interface in interfaces %}
			<option value="{{ interface.snmpid }}">{{ interface.name }} ({{ interface.description }})</option>
		{% endfor %}
			<option value="other">other...</option>
	</select>
	<input type="text" class="form-control validate-numeric" id="interface-input" name="interface" value="" placeholder="SNMPid" hidden="true">
</div>
<button type="button" class="btn btn-outline-success ml-2" onclick="getChartsData()">Show</button>
{% endblock %}


{% block content %}

<div class="container-fluid mb-3">
<div class="row mt-3 justify-content-center">
		<div class="card">
			<div class="card-body text-center">
				<div class="col text-center mt-2" id='chart'>Type not sampling interface SNMP ID and press 'Show' button</div>
			</div>
			<div class="card-footer text-muted text-center charts-title">{{ direction }} traffic</div>
		</div>
</div>
<script>
chartOptions = { 'width': 1000, 'height': 500 }
google.charts.load('current', {'packages':['corechart', 'sankey']});


function getChartsData() {
	if (validate()) {
		var host = $('#host-select').val();
		var date = new Date(dateToISO($('#date-select').val()));
		var direction = $('#direction-select').val();
		var intrf = $('#interface-select').val();
		if (intrf == 'other') intrf = $('#interface-input').val();
		$('.charts-title').text(direction + " traffic")
		$.ajax({
				type: 'post',
				url: 'get_interface_chart_data',
				dataType: "json",
				data: {
					'host' : host,
					'date' : date.toISOString(),
					'direction' : direction,
					'interface' : intrf
				},
				success: function(data){
					drawCharts(data);
				},
				async: true
		})
	}
}


function drawCharts(chartsData) {
	var data = google.visualization.arrayToDataTable(chartsData);
	var chart = new google.visualization.Sankey(document.getElementById('chart'));
	var rowsCount = data.getNumberOfRows();
	chartOptions.height = rowsCount*15;
	if (chartOptions.height < 500) chartOptions.height = 500;
	chart.draw(data, chartOptions);
}


$('#host-select').change(function(){
	document.location.href = "?host=" + $('#host-select').val() + "&direction=" + $('#direction-select').val();
})

$('#direction-select').change(function(){
	document.location.href = "?host=" + $('#host-select').val() + "&direction=" + $('#direction-select').val();
})

$('#interface-select').change(function(){
	if ($('#interface-select').val() == "other") {
		$('#interface-input').removeAttr('hidden');
		$('#interface-input').addClass('need-validate');
	} else {
		$('#interface-input').attr('hidden', 'true');
		$('#interface-input').removeClass('need-validate');
	}
})


</script>

{% endblock %}
